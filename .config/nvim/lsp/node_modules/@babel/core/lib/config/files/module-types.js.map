{"version":3,"names":["isAsync","waitFor","path","pathToFileURL","createRequire","semver","endHiddenCallStack","ConfigError","transformFileSync","require","import","meta","url","import_","_unused","supportsESM","satisfies","process","versions","node","loadCodeDefault","filepath","asyncError","fallbackToTranspiledModule","extname","loadCjsDefault","loadCtsDefault","e","code","loadMjsDefault","ext","hasTsSupport","extensions","handler","opts","babelrc","configFile","sourceType","sourceMaps","sourceFileName","basename","presets","getTSPreset","Object","assign","onlyRemoveTypeImports","optimizeConstEnums","allowDeclareFields","m","filename","endsWith","_compile","error","packageJson","lte","version","console","module","__esModule","default","undefined","_x","_loadMjsDefault","apply","arguments","_asyncToGenerator","message","pnp"],"sources":["../../../src/config/files/module-types.ts"],"sourcesContent":["import { isAsync, waitFor } from \"../../gensync-utils/async\";\nimport type { Handler } from \"gensync\";\nimport path from \"path\";\nimport { pathToFileURL } from \"url\";\nimport { createRequire } from \"module\";\nimport semver from \"semver\";\n\nimport { endHiddenCallStack } from \"../../errors/rewrite-stack-trace\";\nimport ConfigError from \"../../errors/config-error\";\n\nimport type { InputOptions } from \"..\";\nimport { transformFileSync } from \"../../transform-file\";\n\nconst require = createRequire(import.meta.url);\n\nlet import_: ((specifier: string | URL) => any) | undefined;\ntry {\n  // Old Node.js versions don't support import() syntax.\n  import_ = require(\"./import.cjs\");\n} catch {}\n\nexport const supportsESM = semver.satisfies(\n  process.versions.node,\n  // older versions, starting from 10, support the dynamic\n  // import syntax but always return a rejected promise.\n  \"^12.17 || >=13.2\",\n);\n\nexport default function* loadCodeDefault(\n  filepath: string,\n  asyncError: string,\n  // TODO(Babel 8): Remove this\n  fallbackToTranspiledModule: boolean = false,\n): Handler<unknown> {\n  switch (path.extname(filepath)) {\n    case \".cjs\":\n      return loadCjsDefault(filepath, fallbackToTranspiledModule);\n    case \".mjs\":\n      break;\n    case \".cts\":\n      return loadCtsDefault(filepath);\n    default:\n      try {\n        return loadCjsDefault(filepath, fallbackToTranspiledModule);\n      } catch (e) {\n        if (e.code !== \"ERR_REQUIRE_ESM\") throw e;\n      }\n  }\n  if (yield* isAsync()) {\n    return yield* waitFor(loadMjsDefault(filepath));\n  }\n  throw new ConfigError(asyncError, filepath);\n}\n\nfunction loadCtsDefault(filepath: string) {\n  const ext = \".cts\";\n  const hasTsSupport = !!(\n    require.extensions[\".ts\"] ||\n    require.extensions[\".cts\"] ||\n    require.extensions[\".mts\"]\n  );\n\n  let handler: NodeJS.RequireExtensions[\"\"];\n\n  if (!hasTsSupport) {\n    const opts: InputOptions = {\n      babelrc: false,\n      configFile: false,\n      sourceType: \"unambiguous\",\n      sourceMaps: \"inline\",\n      sourceFileName: path.basename(filepath),\n      presets: [\n        [\n          getTSPreset(filepath),\n          {\n            onlyRemoveTypeImports: true,\n            optimizeConstEnums: true,\n            ...(process.env.BABEL_8_BREAKING\n              ? {}\n              : { allowDeclareFields: true }),\n          },\n        ],\n      ],\n    };\n\n    handler = function (m, filename) {\n      // If we want to support `.ts`, `.d.ts` must be handled specially.\n      if (handler && filename.endsWith(ext)) {\n        try {\n          // @ts-expect-error Undocumented API\n          return m._compile(\n            transformFileSync(filename, {\n              ...opts,\n              filename,\n            }).code,\n            filename,\n          );\n        } catch (error) {\n          if (!hasTsSupport) {\n            const packageJson = require(\"@babel/preset-typescript/package.json\");\n            if (semver.lte(packageJson.version, \"7.21.4\")) {\n              console.error(\n                \"`.cts` configuration file failed to load, please try to update `@babel/preset-typescript`.\",\n              );\n            }\n          }\n          throw error;\n        }\n      }\n      return require.extensions[\".js\"](m, filename);\n    };\n    require.extensions[ext] = handler;\n  }\n  try {\n    const module = endHiddenCallStack(require)(filepath);\n    return module?.__esModule ? module.default : module;\n  } finally {\n    if (!hasTsSupport) {\n      if (require.extensions[ext] === handler) delete require.extensions[ext];\n      handler = undefined;\n    }\n  }\n}\n\nfunction loadCjsDefault(filepath: string, fallbackToTranspiledModule: boolean) {\n  const module = endHiddenCallStack(require)(filepath);\n  return module?.__esModule\n    ? // TODO (Babel 8): Remove \"module\" and \"undefined\" fallback\n      module.default || (fallbackToTranspiledModule ? module : undefined)\n    : module;\n}\n\nasync function loadMjsDefault(filepath: string) {\n  if (!import_) {\n    throw new ConfigError(\n      \"Internal error: Native ECMAScript modules aren't supported by this platform.\\n\",\n      filepath,\n    );\n  }\n\n  // import() expects URLs, not file paths.\n  // https://github.com/nodejs/node/issues/31710\n  const module = await endHiddenCallStack(import_)(pathToFileURL(filepath));\n  return module.default;\n}\n\nfunction getTSPreset(filepath: string) {\n  try {\n    // eslint-disable-next-line import/no-extraneous-dependencies\n    return require(\"@babel/preset-typescript\");\n  } catch (error) {\n    if (error.code !== \"MODULE_NOT_FOUND\") throw error;\n\n    let message =\n      \"You appear to be using a .cts file as Babel configuration, but the `@babel/preset-typescript` package was not found: please install it!\";\n\n    if (process.versions.pnp) {\n      // Using Yarn PnP, which doesn't allow requiring packages that are not\n      // explicitly specified as dependencies.\n      // TODO(Babel 8): Explicitly add `@babel/preset-typescript` as an\n      // optional peer dependency of `@babel/core`.\n      message += `\nIf you are using Yarn Plug'n'Play, you may also need to add the following configuration to your .yarnrc.yml file:\n\npackageExtensions:\n\\t\"@babel/core@*\":\n\\t\\tpeerDependencies:\n\\t\\t\\t\"@babel/preset-typescript\": \"*\"\n`;\n    }\n\n    throw new ConfigError(message, filepath);\n  }\n}\n"],"mappings":"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"}