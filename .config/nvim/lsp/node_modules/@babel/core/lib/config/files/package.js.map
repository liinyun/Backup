{"version":3,"names":["path","makeStaticFileCache","ConfigError","PACKAGE_FILENAME","readConfigPackage","filepath","content","options","JSON","parse","err","message","Error","Array","isArray","dirname","findPackageData","pkg","directories","isPackage","basename","push","join","nextLoc"],"sources":["../../../src/config/files/package.ts"],"sourcesContent":["import path from \"path\";\nimport type { Handler } from \"gensync\";\nimport { makeStaticFileCache } from \"./utils\";\n\nimport type { ConfigFile, FilePackageData } from \"./types\";\n\nimport ConfigError from \"../../errors/config-error\";\n\nconst PACKAGE_FILENAME = \"package.json\";\n\nconst readConfigPackage = makeStaticFileCache(\n  (filepath, content): ConfigFile => {\n    let options;\n    try {\n      options = JSON.parse(content) as unknown;\n    } catch (err) {\n      throw new ConfigError(\n        `Error while parsing JSON - ${err.message}`,\n        filepath,\n      );\n    }\n\n    if (!options) throw new Error(`${filepath}: No config detected`);\n\n    if (typeof options !== \"object\") {\n      throw new ConfigError(\n        `Config returned typeof ${typeof options}`,\n        filepath,\n      );\n    }\n    if (Array.isArray(options)) {\n      throw new ConfigError(`Expected config object but found array`, filepath);\n    }\n\n    return {\n      filepath,\n      dirname: path.dirname(filepath),\n      options,\n    };\n  },\n);\n\n/**\n * Find metadata about the package that this file is inside of. Resolution\n * of Babel's config requires general package information to decide when to\n * search for .babelrc files\n */\nexport function* findPackageData(filepath: string): Handler<FilePackageData> {\n  let pkg = null;\n  const directories = [];\n  let isPackage = true;\n\n  let dirname = path.dirname(filepath);\n  while (!pkg && path.basename(dirname) !== \"node_modules\") {\n    directories.push(dirname);\n\n    pkg = yield* readConfigPackage(path.join(dirname, PACKAGE_FILENAME));\n\n    const nextLoc = path.dirname(dirname);\n    if (dirname === nextLoc) {\n      isPackage = false;\n      break;\n    }\n    dirname = nextLoc;\n  }\n\n  return { filepath, directories, pkg, isPackage };\n}\n"],"mappings":"AAAA,OAAOA,IAAI,MAAM,MAAM;AAEvB,SAASC,mBAAmB,QAAQ,YAAS;AAI7C,OAAOC,WAAW,MAAM,8BAA2B;AAEnD,MAAMC,gBAAgB,GAAG,cAAc;AAEvC,MAAMC,iBAAiB,GAAGH,mBAAmB,CAC3C,CAACI,QAAQ,EAAEC,OAAO,KAAiB;EACjC,IAAIC,OAAO;EACX,IAAI;IACFA,OAAO,GAAGC,IAAI,CAACC,KAAK,CAACH,OAAO,CAAY;EAC1C,CAAC,CAAC,OAAOI,GAAG,EAAE;IACZ,MAAM,IAAIR,WAAW,CAClB,8BAA6BQ,GAAG,CAACC,OAAQ,EAAC,EAC3CN,QAAQ,CACT;EACH;EAEA,IAAI,CAACE,OAAO,EAAE,MAAM,IAAIK,KAAK,CAAE,GAAEP,QAAS,sBAAqB,CAAC;EAEhE,IAAI,OAAOE,OAAO,KAAK,QAAQ,EAAE;IAC/B,MAAM,IAAIL,WAAW,CAClB,0BAAyB,OAAOK,OAAQ,EAAC,EAC1CF,QAAQ,CACT;EACH;EACA,IAAIQ,KAAK,CAACC,OAAO,CAACP,OAAO,CAAC,EAAE;IAC1B,MAAM,IAAIL,WAAW,CAAE,wCAAuC,EAAEG,QAAQ,CAAC;EAC3E;EAEA,OAAO;IACLA,QAAQ;IACRU,OAAO,EAAEf,IAAI,CAACe,OAAO,CAACV,QAAQ,CAAC;IAC/BE;EACF,CAAC;AACH,CAAC,CACF;AAOD,OAAO,UAAUS,eAAeA,CAACX,QAAgB,EAA4B;EAC3E,IAAIY,GAAG,GAAG,IAAI;EACd,MAAMC,WAAW,GAAG,EAAE;EACtB,IAAIC,SAAS,GAAG,IAAI;EAEpB,IAAIJ,OAAO,GAAGf,IAAI,CAACe,OAAO,CAACV,QAAQ,CAAC;EACpC,OAAO,CAACY,GAAG,IAAIjB,IAAI,CAACoB,QAAQ,CAACL,OAAO,CAAC,KAAK,cAAc,EAAE;IACxDG,WAAW,CAACG,IAAI,CAACN,OAAO,CAAC;IAEzBE,GAAG,GAAG,OAAOb,iBAAiB,CAACJ,IAAI,CAACsB,IAAI,CAACP,OAAO,EAAEZ,gBAAgB,CAAC,CAAC;IAEpE,MAAMoB,OAAO,GAAGvB,IAAI,CAACe,OAAO,CAACA,OAAO,CAAC;IACrC,IAAIA,OAAO,KAAKQ,OAAO,EAAE;MACvBJ,SAAS,GAAG,KAAK;MACjB;IACF;IACAJ,OAAO,GAAGQ,OAAO;EACnB;EAEA,OAAO;IAAElB,QAAQ;IAAEa,WAAW;IAAED,GAAG;IAAEE;EAAU,CAAC;AAClD"}